# 线性多分类原理

此原理对线性多分类和非线性多分类都适用。

## 多分类过程

我们在此以具有两个特征值的三分类举例。可以扩展到更多的分类或任意特征值，比如在ImageNet的图像分类任务中，最后一层全连接层输出给分类器的特征值有成千上万个，分类有1000个。

1. 线性计算

$$z\_1 = x\_1 w\_{11} + x\_2 w\_{21} + b\_1 \tag{1}$$ $$z\_2 = x\_1 w\_{12} + x\_2 w\_{22} + b\_2 \tag{2}$$ $$z\_3 = x\_1 w\_{13} + x\_2 w\_{23} + b\_3 \tag{3}$$

1. 分类计算

$$ a\_1=\frac{e^{z\_1}}{\sum\_i e^{z\_i}}=\frac{e^{z\_1}}{e^{z\_1}+e^{z\_2}+e^{z\_3}} \tag{4} $$ $$ a\_2=\frac{e^{z\_2}}{\sum\_i e^{z\_i}}=\frac{e^{z\_2}}{e^{z\_1}+e^{z\_2}+e^{z\_3}} \tag{5} $$ $$ a\_3=\frac{e^{z\_3}}{\sum\_i e^{z\_i}}=\frac{e^{z\_3}}{e^{z\_1}+e^{z\_2}+e^{z\_3}} \tag{6} $$

1. 损失函数计算

单样本时，$n$表示类别数，$j$表示类别序号：

$$ \begin{aligned} loss\(w,b\)&=-\(y\_1 \ln a\_1 + y\_2 \ln a\_2 + y\_3 \ln a\_3\) \ &=-\sum\_{j=1}^{n} y\_j \ln a\_j \end{aligned} \tag{7} $$

批量样本时，$m$表示样本数，$i$表示样本序号：

$$ \begin{aligned} J\(w,b\) &=- \sum\_{i=1}^m \(y\_{i1} \ln a\_{i1} + y\_{i2} \ln a\_{i2} + y\_{i3} \ln a\_{i3}\) \ &=- \sum\_{i=1}^m \sum\_{j=1}^n y\_{ij} \ln a\_{ij} \end{aligned} \tag{8} $$

损失函数计算在交叉熵函数一节有详细介绍。

## 7.3.2 数值计算举例

假设对预测一个样本的计算得到的$z$值为：

$$z=\[z\_1,z\_2,z\_3\]=\[3,1,-3\]$$

则按公式4、5、6进行计算，可以得出Softmax的概率分布是：

$$a=\[a\_1,a\_2,a\_3\]=\[0.879,0.119,0.002\]$$

### 如果标签值表明此样本为第一类

即：

$$y=\[1,0,0\]$$

则损失函数为：

$$ loss\_1=-\(1 \times \ln 0.879 + 0 \times \ln 0.119 + 0 \times \ln 0.002\)=0.123 $$

反向传播误差矩阵为：

$$a-y=\[-0.121,0.119,0.002\]$$

因为$a\_1=0.879$，为三者最大，分类正确，所以$a-y$的三个值都不大。

### 如果标签值表明此样本为第二类

即：

$$y=\[0,1,0\]$$

则损失函数为：

$$ loss\_2=-\(0 \times \ln 0.879 + 1 \times \ln 0.119 + 0 \times \ln 0.002\)=2.128 $$

可以看到由于分类错误，$loss\_2$的值比$loss\_1$的值大很多。

反向传播误差矩阵为：

$$a-y=\[0.879,0.881,0.002\]$$

本来是第二类，误判为第一类，所以前两个元素的值很大，反向传播的力度就大。

## 7.3.3 多分类的几何原理

在前面的二分类原理中，很容易理解为我们用一条直线分开两个部分。对于多分类问题，是否可以沿用二分类原理中的几何解释呢？答案是肯定的，只不过需要单独判定每一个类别。

假设一共有三类样本，蓝色为1，红色为2，绿色为3，那么Softmax的形式应该是：

$$ a\_j = \frac{e^{z\_j}}{\sum\limits\_{i=1}^3 e^{z\_i}}=\frac{e^{z\_j}}{e^{z\_1}+e^{z\_2}+^{z\_3}} $$

### 当样本属于第一类时

把蓝色点与其它颜色的点分开。

如果判定一个点属于第一类，则$a\_1$的概率值一定会比$a\_2、a\_3$大，表示为公式：

$$a\_1 &gt; a\_2 且 a\_1 &gt; a\_3 \tag{9}$$

由于Softmax的特殊形式，分母都一样，所以只比较分子就行了。而分子是一个自然指数，输出值域大于零且单调递增，所以只比较指数就可以了，因此，公式9等同于下式：

$$z\_1 &gt; z\_2 且 z\_1 &gt; z\_3 \tag{10}$$

把公式1、2、3引入到10：

$$x\_1 w\_{11} + x\_2 w\_{21} + b1 &gt; x\_1 w\_{12} + x\_2 w\_{22} + b\_2 \tag{11}$$ $$x\_1 w\_{11} + x\_2 w\_{21} + b1 &gt; x\_1 w\_{13} + x\_2 w\_{23} + b\_3 \tag{12}$$

变形：

$$\(w\_{21} - w\_{22}\)x\_2 &gt; \(w\_{12} - w\_{11}\)x\_1 + \(b\_2 - b\_1\) \tag{13}$$

$$\(w\_{21} - w\_{23}\)x\_2 &gt; \(w\_{13} - w\_{11}\)x\_1 + \(b\_3 - b\_1\) \tag{14}$$

我们先假设：

$$w\_{21} &gt; w\_{22}，且 w\_{21}&gt; w\_{23} \tag{15}$$

所以公式13、14左侧的系数都大于零，两边同时除以系数：

$$x\_2 &gt; {w\_{12} - w\_{11} \over w\_{21} - w\_{22}}x\_1 + {b\_2 - b\_1 \over w\_{21} - w\_{22}} \tag{16}$$

$$x\_2 &gt; {w\_{13} - w\_{11} \over w\_{21} - w\_{23}} x\_1 + {b\_3 - b\_1 \over w\_{21} - w\_{23}} \tag{17}$$

简化：

$$y &gt; W\_{12} \cdot x + B\_{12} \tag{18}$$

$$y &gt; W\_{13} \cdot x + B\_{13} \tag{19}$$

此时y代表了第一类的蓝色点。

图7-9 如何把蓝色样本与其它两色的样本分开

借用二分类中的概念，公式18的几何含义是：有一条直线可以分开第一类（蓝色点）和第二类（红色点），使得所有蓝色点都在直线的上方，所有的红色点都在直线的下方。于是我们可以画出图7-9中的那条绿色直线。

而公式19的几何含义是：有一条直线可以分开第一类（蓝色点）和第三类（绿色点），使得所有蓝色点都在直线的上方，所有的绿色点都在直线的下方。于是我们可以画出图7-9中的那条红色直线。

也就是说在图中画两条直线，所有蓝点都同时在红线和绿线这两条直线的上方。

### 当样本属于第二类时

即如何把红色点与其它两色点分开。

$$z\_2 &gt; z\_1 且 z\_2 &gt; z\_3 \tag{20}$$

同理可得

$$y &lt; W\_{12} \cdot x + B\_{12} \tag{21}$$

$$y &gt; W\_{23} \cdot x + B\_{23} \tag{22}$$

图7-10 如何把红色样本与其它两色的样本分开

此时$y$代表了第二类的红色点。

公式21和公式18几何含义相同，不等号相反，代表了图7-10中绿色直线的分割作用，即红色点在绿色直线下方。

公式22的几何含义是，有一条蓝色直线可以分开第二类（红色点）和第三类（绿色点），使得所有红色点都在直线的上方，所有的绿色点都在直线的下方。

### 当样本属于第三类时

即如何把绿色点与其它两色点分开。

$$z\_3 &gt; z\_1 且 z\_3 &gt; z\_2 \tag{22}$$

最后可得：

$$y &lt; W\_{13} \cdot x + B\_{13} \tag{23}$$

$$y &lt; W\_{23} \cdot x + B\_{23} \tag{24}$$

此时$y$代表了第三类的绿色点。

图7-11 如何把绿色样本与其它两色的样本分开

公式23与公式19不等号相反，几何含义相同，代表了图7-11中红色直线的分割作用，绿色点在红色直线下方。

公式24与公式22不等号相反，几何含义相同，代表了图7-11中蓝色直线的分割作用，绿色点在蓝色直线下方。

### 综合效果

把三张图综合在一起，应该是图7-12的样子。

图7-12 三条线分开三种样本

## 思考与练习

1. 我们假设$w\_{21} &gt; w\_{22} &gt; w\_{23}$是否有根据呢？假设$w\_{21} &gt; w\_{23} &gt; w\_{23}$，直线的位置会有所变化吗？
2. 最后一张图的三条直线应该相交于一点吗？

